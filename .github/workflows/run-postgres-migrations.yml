name: Run PostgreSQL Migrations

on:
  workflow_dispatch:  # Manual trigger only

jobs:
  run-migrations:
    name: Run Database Migrations
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: us-east-1

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install psycopg2-binary

      - name: Get PostgreSQL credentials from Secrets Manager
        id: get-creds
        run: |
          SECRET_JSON=$(aws secretsmanager get-secret-value \
            --secret-id fluxion/postgres-credentials \
            --query SecretString --output text)

          echo "POSTGRES_USER=$(echo $SECRET_JSON | jq -r .username)" >> $GITHUB_ENV
          echo "POSTGRES_PASSWORD=$(echo $SECRET_JSON | jq -r .password)" >> $GITHUB_ENV

      - name: Get RDS endpoint from CloudFormation
        run: |
          POSTGRES_HOST=$(aws cloudformation describe-stacks \
            --stack-name FluxionStackV2 \
            --query 'Stacks[0].Outputs[?OutputKey==`PostgreSQLEndpoint`].OutputValue' \
            --output text)

          echo "POSTGRES_HOST=$POSTGRES_HOST" >> $GITHUB_ENV
          echo "POSTGRES_PORT=5432" >> $GITHUB_ENV
          echo "POSTGRES_DB=fluxion_production" >> $GITHUB_ENV

      - name: Run database migrations
        run: |
          cd database
          python3 run_migrations.py --list
          python3 run_migrations.py --up
          echo ""
          echo "âœ… Migrations completed successfully!"
          echo ""
          python3 run_migrations.py --list
